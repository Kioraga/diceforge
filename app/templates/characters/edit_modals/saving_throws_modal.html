<!-- Modal para editar tiradas de salvación -->
<dialog id="edit_saving_throws_modal" class="modal">
    <div class="modal-box max-w-2xl h-full w-full md:w-11/12 md:h-auto">
        <h3 class="font-bold text-lg mb-4">Editar Tiradas de Salvación</h3>
        <form method="POST" action="{{ url_for('characters.update_character', char_id=character.id) }}"
              class="space-y-4">
            <input type="hidden" name="modal" value="saving_throws">

            <div class="overflow-x-auto">
                <table class="table w-full">
                    <tbody>

                    <tr>
                        <td class="text-center">Competencia</td>
                    </tr>

                    <!-- Fuerza -->
                    <tr>
                        <td class="text-center space-x-1">
                            {% set strength_proficiency = character.proficiencies.get('strength', {}) %}
                            <input type="checkbox" class="checkbox checkbox-sm proficiency-checkbox"
                                   name="strength_proficiency"
                                   data-ability="strength"
                                   data-mod="{{ strength_mod }}"
                                   onclick="toggleProficiency(this, false)"
                                   {% if strength_proficiency.get('proficiency', False) %}checked="checked"{% endif %}/>
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-accent expertise-checkbox"
                                   name="strength_expertise"
                                   data-ability="strength"
                                   data-mod="{{ strength_mod }}"
                                   onclick="toggleProficiency(this, true)"
                                   {% if strength_proficiency.get('expertise', False) %}checked="checked"{% endif %}/>
                        </td>
                        <td>Fuerza (Fue)</td>
                        {% set save_strength = strength_mod %}
                        {% if strength_proficiency.get('proficiency', False) %}
                            {% set save_strength = strength_mod + proficiency_bonus %}
                        {% elif strength_proficiency.get('expertise', False) %}
                            {% set save_strength = strength_mod + (2 * proficiency_bonus) %}
                        {% endif %}
                        <td class="text-right">{{ "%+d"|format(save_strength) }}</td>
                    </tr>

                    <!-- Destreza -->
                    <tr>
                        <td class="text-center space-x-1">
                            {% set dexterity_proficiency = character.proficiencies.get('dexterity', {}) %}
                            <input type="checkbox" class="checkbox checkbox-sm proficiency-checkbox"
                                   name="dexterity_proficiency"
                                   data-ability="dexterity"
                                   data-mod="{{ dexterity_mod }}"
                                   onclick="toggleProficiency(this, false)"
                                   {% if dexterity_proficiency.get('proficiency', False) %}checked="checked"{% endif %}/>
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-accent expertise-checkbox"
                                   name="dexterity_expertise"
                                   data-ability="dexterity"
                                   data-mod="{{ dexterity_mod }}"
                                   onclick="toggleProficiency(this, true)"
                                   {% if dexterity_proficiency.get('expertise', False) %}checked="checked"{% endif %}/>
                        </td>
                        <td>Destreza (Des)</td>
                        {% set save_dexterity = dexterity_mod %}
                        {% if dexterity_proficiency.get('proficiency', False) %}
                            {% set save_dexterity = dexterity_mod + proficiency_bonus %}
                        {% elif dexterity_proficiency.get('expertise', False) %}
                            {% set save_dexterity = dexterity_mod + (2 * proficiency_bonus) %}
                        {% endif %}
                        <td class="text-right">{{ "%+d"|format(save_dexterity) }}</td>
                    </tr>

                    <!-- Constitución -->
                    <tr>
                        <td class="text-center space-x-1">
                            {% set constitution_proficiency = character.proficiencies.get('constitution', {}) %}
                            <input type="checkbox" class="checkbox checkbox-sm proficiency-checkbox"
                                   name="constitution_proficiency"
                                   data-ability="constitution"
                                   data-mod="{{ constitution_mod }}"
                                   onclick="toggleProficiency(this, false)"
                                   {% if constitution_proficiency.get('proficiency', False) %}checked="checked"{% endif %}/>
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-accent expertise-checkbox"
                                   name="constitution_expertise"
                                   data-ability="constitution"
                                   data-mod="{{ constitution_mod }}"
                                   onclick="toggleProficiency(this, true)"
                                   {% if constitution_proficiency.get('expertise', False) %}checked="checked"{% endif %}/>
                        </td>
                        <td>Constitución (Con)</td>
                        {% set save_constitution = constitution_mod %}
                        {% if constitution_proficiency.get('proficiency', False) %}
                            {% set save_constitution = constitution_mod + proficiency_bonus %}
                        {% elif constitution_proficiency.get('expertise', False) %}
                            {% set save_constitution = constitution_mod + (2 * proficiency_bonus) %}
                        {% endif %}
                        <td class="text-right">{{ "%+d"|format(save_constitution) }}</td>
                    </tr>

                    <!-- Inteligencia -->
                    <tr>
                        <td class="text-center space-x-1">
                            {% set intelligence_proficiency = character.proficiencies.get('intelligence', {}) %}
                            <input type="checkbox" class="checkbox checkbox-sm proficiency-checkbox"
                                   name="intelligence_proficiency"
                                   data-ability="intelligence"
                                   data-mod="{{ intelligence_mod }}"
                                   onclick="toggleProficiency(this, false)"
                                   {% if intelligence_proficiency.get('proficiency', False) %}checked="checked"{% endif %}/>
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-accent expertise-checkbox"
                                   name="intelligence_expertise"
                                   data-ability="intelligence"
                                   data-mod="{{ intelligence_mod }}"
                                   onclick="toggleProficiency(this, true)"
                                   {% if intelligence_proficiency.get('expertise', False) %}checked="checked"{% endif %}/>
                        </td>
                        <td>Inteligencia (Int)</td>
                        {% set save_intelligence = intelligence_mod %}
                        {% if intelligence_proficiency.get('proficiency', False) %}
                            {% set save_intelligence = intelligence_mod + proficiency_bonus %}
                        {% elif intelligence_proficiency.get('expertise', False) %}
                            {% set save_intelligence = intelligence_mod + (2 * proficiency_bonus) %}
                        {% endif %}
                        <td class="text-right">{{ "%+d"|format(save_intelligence) }}</td>
                    </tr>

                    <!-- Sabiduría -->
                    <tr>
                        <td class="text-center space-x-1">
                            {% set wisdom_proficiency = character.proficiencies.get('wisdom', {}) %}
                            <input type="checkbox" class="checkbox checkbox-sm proficiency-checkbox"
                                   name="wisdom_proficiency"
                                   data-ability="wisdom"
                                   data-mod="{{ wisdom_mod }}"
                                   onclick="toggleProficiency(this, false)"
                                   {% if wisdom_proficiency.get('proficiency', False) %}checked="checked"{% endif %}/>
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-accent expertise-checkbox"
                                   name="wisdom_expertise"
                                   data-ability="wisdom"
                                   data-mod="{{ wisdom_mod }}"
                                   onclick="toggleProficiency(this, true)"
                                   {% if wisdom_proficiency.get('expertise', False) %}checked="checked"{% endif %}/>
                        </td>
                        <td>Sabiduría (Sab)</td>
                        {% set save_wisdom = wisdom_mod %}
                        {% if wisdom_proficiency.get('proficiency', False) %}
                            {% set save_wisdom = wisdom_mod + proficiency_bonus %}
                        {% elif wisdom_proficiency.get('expertise', False) %}
                            {% set save_wisdom = wisdom_mod + (2 * proficiency_bonus) %}
                        {% endif %}
                        <td class="text-right">{{ "%+d"|format(save_wisdom) }}</td>
                    </tr>

                    <!-- Carisma -->
                    <tr>
                        <td class="text-center space-x-1">
                            {% set charisma_proficiency = character.proficiencies.get('charisma', {}) %}
                            <input type="checkbox" class="checkbox checkbox-sm proficiency-checkbox"
                                   name="charisma_proficiency"
                                   data-ability="charisma"
                                   data-mod="{{ charisma_mod }}"
                                   onclick="toggleProficiency(this, false)"
                                   {% if charisma_proficiency.get('proficiency', False) %}checked="checked"{% endif %}/>
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-accent expertise-checkbox"
                                   data-ability="charisma"
                                   data-mod="{{ charisma_mod }}"
                                   onclick="toggleProficiency(this, true)"
                                   {% if charisma_proficiency.get('expertise', False) %}checked="checked"{% endif %}/>
                        </td>
                        <td>Carisma (Car)</td>
                        {% set save_charisma = charisma_mod %}
                        {% if charisma_proficiency.get('proficiency', False) %}
                            {% set save_charisma = charisma_mod + proficiency_bonus %}
                        {% elif charisma_proficiency.get('expertise', False) %}
                            {% set save_charisma = charisma_mod + (2 * proficiency_bonus) %}
                        {% endif %}
                        <td class="text-right">{{ "%+d"|format(save_charisma) }}</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="edit_saving_throws_modal.close()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar los valores de los bonos al cargar la página
            initializeProficiencyBonuses();
        });

        function initializeProficiencyBonuses() {
            const proficiencyBonus = parseInt("{{ proficiency_bonus | tojson }}");
            const checkboxes = document.querySelectorAll('.proficiency-checkbox, .expertise-checkbox');

            checkboxes.forEach(checkbox => {
                const ability = checkbox.dataset.ability;
                const mod = parseInt(checkbox.dataset.mod);
                const isExpertise = checkbox.classList.contains('expertise-checkbox');
                const bonusCell = checkbox.closest('tr').querySelector('td:last-child');

                // Guardar el valor base del modificador
                if (!checkbox.dataset.originalValue) {
                    checkbox.dataset.originalValue = mod.toString();
                }

                // Actualizar el valor mostrado
                updateBonusDisplay(checkbox, bonusCell, proficiencyBonus);
            });
        }

        function toggleProficiency(checkbox, isExpertise) {
            const proficiencyBonus = parseInt("{{ proficiency_bonus | tojson }}");
            const ability = checkbox.dataset.ability;
            const row = checkbox.closest('tr');
            const proficiencyCheckbox = row.querySelector('.proficiency-checkbox');
            const expertiseCheckbox = row.querySelector('.expertise-checkbox');
            const bonusCell = row.querySelector('td:last-child');

            if (isExpertise) {
                // Si se está marcando expertise, asegurarse de que proficiency también esté marcado
                if (checkbox.checked && !proficiencyCheckbox.checked) {
                    proficiencyCheckbox.checked = true;
                    updateBonusDisplay(proficiencyCheckbox, bonusCell, proficiencyBonus);
                }
            } else {
                // Si se está desmarcando proficiency, asegurarse de que expertise también se desmarque
                if (!checkbox.checked && expertiseCheckbox.checked) {
                    expertiseCheckbox.checked = false;
                    updateBonusDisplay(expertiseCheckbox, bonusCell, proficiencyBonus);
                }
            }

            // Actualizar la visualización del bono
            updateBonusDisplay(checkbox, bonusCell, proficiencyBonus);
        }

        function updateBonusDisplay(checkbox, bonusCell, proficiencyBonus) {
            const isExpertise = checkbox.classList.contains('expertise-checkbox');
            const row = checkbox.closest('tr');
            const proficiencyCheckbox = row.querySelector('.proficiency-checkbox');
            const expertiseCheckbox = row.querySelector('.expertise-checkbox');
            const mod = parseInt(checkbox.dataset.mod);

            let bonus = mod;

            if (expertiseCheckbox.checked) {
                bonus += 2 * proficiencyBonus;
            } else if (proficiencyCheckbox.checked) {
                bonus += proficiencyBonus;
            }

            // Actualizar el valor mostrado
            bonusCell.textContent = (bonus >= 0 ? '+' : '') + bonus;

            // Actualizar los campos ocultos para el formulario
            const ability = checkbox.dataset.ability;
            const hiddenInput = document.querySelector(`input[name="proficiency_${ability}"]`);

            if (expertiseCheckbox.checked) {
                hiddenInput.value = 'expertise';
            } else if (proficiencyCheckbox.checked) {
                hiddenInput.value = 'proficiency';
            } else {
                hiddenInput.value = '';
            }
        }
    </script>
</dialog>